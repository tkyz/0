#!/usr/bin/env python3

import os
import re
import git
import json
import magic

def main():

  tokens = set()

  # tokens <- git
  repo = git.Repo('.', search_parent_directories=True)
  for f in repo.git.ls_files().split('\n'):

    f = os.path.join(repo.working_tree_dir, f)

    # tokens <- path
    tokens |= split(f)

    # tokens <- *file
    if os.path.isfile(f):

      mime_type = magic.from_file(f, mime=True)
      tokens |= split(mime_type)

      read  = False
      read |= mime_type.startswith("text/")
      read |= mime_type.startswith("application/json")
      if read:

        with open(f, 'r') as f_:
          text = f_.read()

        tokens |= split(text)

  # TODO: --format=raw
  if False:
    for t in sorted(list(tokens)):
      print(t)

  # TODO: --format=json
  else:
    print(json.dumps(sorted(list(tokens)), ensure_ascii=False))

def split(s):

  # TODO: delims
  delims = [
    r',\.', r'、。',
    r';:',  r'；：',
    r'"\'',
    r'`',
    r'!',
    r'$',
    r'&',
    r'?',
    r'%',
    r'#',
    r'@',
    r'・',
    r'_',
    r'^',
    r'~',
    r'\+\-\*/=',
    r'\(\)\[\]{}<>', r'（）「」｛｝＜＞',
    r'\\\s',
    r'|',
  ]

  regex = '[' + ''.join(delims) + ']'
 
  return {t for t in re.split(regex, s) if t}

if __name__ == '__main__':
  main()
